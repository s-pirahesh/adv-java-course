<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بخش 19: مدیریت استثناها (Exception Handling) | برنامه‌سازی پیشرفته</title>

    <meta name="description" content="آموزش جامع مدیریت استثناها در جاوا، تفاوت Checked و Unchecked، بلوک try-catch-finally و ساخت استثنای سفارشی">

    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet"/>

    <style>
        /* استایل‌های اختصاصی دیاگرام سلسله‌مراتب */
        .diagram-container svg {
            font-family: 'Vazirmatn', 'Segoe UI', sans-serif;
        }
        .throwable-box {
            fill: #fae8ff; /* fuchsia-50 */
            stroke: #a21caf; /* fuchsia-700 */
            stroke-width: 2px;
        }
        .exception-box {
            fill: #fdf4ff; /* purple-50 */
            stroke: #7e22ce; /* purple-700 */
            stroke-width: 2px;
        }
        .error-box {
            fill: #fef2f2; /* red-50 */
            stroke: #b91c1c; /* red-700 */
            stroke-width: 2px;
        }
        .unchecked-box {
            fill: #fff7ed; /* orange-50 */
            stroke: #ea580c; /* orange-600 */
            stroke-width: 2px;
            stroke-dasharray: 5,5;
        }
        .connector {
            stroke: #6b7280;
            stroke-width: 1.5px;
            fill: none;
        }
        .table-container th {
            background-color: #7e22ce; /* purple-700 */
            color: white;
        }
        .table-container tr:nth-child(even) {
            background-color: #f3e8ff; /* purple-100 */
        }
    </style>
</head>
<body class="theme-part19">

<div id="overlay"></div>

<header id="top-header">
    <button id="menu-toggle">☰</button>
    <h1>19. مدیریت استثناها: هنر برخورد با شرایط غیرمنتظره</h1>
    <div class="breadcrumb">
        <a href="../index.html">خانه</a>
        <span>></span>
        <span>فاز ۴</span>
        <span>></span>
        <span>بخش ۱۹</span>
    </div>
</header>

<nav id="sidebar">
    <div class="sidebar-profile">
        <a href="../index.html" title="بازگشت به صفحه اصلی">
            <img src="../assets/images/university_logo.png" alt="لوگو دانشگاه" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%2314B8A6%22 width=%22100%22 height=%22100%22%3E%3C/rect%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 fill=%22white%22 text-anchor=%22middle%22 dy=%22.3em%22%3EJ%3C/text%3E%3C/svg%3E'">
        </a>
        <h2>برنامه‌سازی پیشرفته (جاوا)</h2>
        <p>مدرس: سید سجاد پیراهش</p>
    </div>

    <ul class="nav-menu">
        <li>
            <header class="open">فهرست بخش 19</header>
            <ul class="submenu open">
                <li><a href="#intro" class="nav-link">مقدمه</a></li>
                <li><a href="#section-1" class="nav-link">۱. سلسله‌مراتب استثناها</a></li>
                <li><a href="#section-2" class="nav-link">۲. Checked vs Unchecked</a></li>
                <li><a href="#section-3" class="nav-link">۳. بلوک try-catch-finally</a></li>
                <li><a href="#section-4" class="nav-link">۴. استثنای سفارشی</a></li>
                <li><a href="#section-5" class="nav-link">۵. اشتباهات رایج</a></li>
                <li><a href="#exercises" class="nav-link">۶. تمرین‌های عملی</a></li>
            </ul>
        </li>
        <li>
            <header>بخش‌های فاز ۴</header>
            <ul class="submenu">
                <li><a href="part14.html" class="nav-link">بخش ۱۴: چندریختی</a></li>
                <li><a href="part15.html" class="nav-link">بخش ۱۵: کلاس‌های انتزاعی</a></li>
                <li><a href="part16.html" class="nav-link">بخش ۱۶: رابط‌ها</a></li>
                <li><a href="part17.html" class="nav-link">بخش ۱۷: تکامل طراحی</a></li>
                <li><a href="part18.html" class="nav-link">بخش ۱۸: کلکسیون‌ها</a></li>
                <li><a href="part19.html" class="nav-link active">بخش ۱۹: مدیریت استثناها</a></li>
            </ul>
        </li>
    </ul>

    <div class="sidebar-footer">
        <a href="../index.html">→ بازگشت به فهرست اصلی</a>
    </div>
</nav>

<main id="main-content">

    <section id="intro">
        <p class="lead">تا به حال، ما در یک "دنیای ایده‌آل" کدنویسی کرده‌ایم؛ جایی که فایل‌ها همیشه وجود دارند، شبکه هرگز قطع نمی‌شود، و کاربران همیشه ورودی صحیح را وارد می‌کنند. اما در دنیای واقعی، همه چیز ممکن است اشتباه پیش برود. به این "اشتباهات" در زمان اجرای برنامه، <strong>استثنا (Exception)</strong> گفته می‌شود.</p>
        <p><strong>مدیریت استثناها</strong> مکانیزمی قدرتمند در جاوا است که به ما اجازه می‌دهد "مسیر شاد" (Happy Path) برنامه را از منطق "مدیریت خطا" جدا کنیم. به جای اینکه برنامه با اولین مشکل کرش کند، ما می‌توانیم خطا را به شیوه‌ای زیبا "گرفته" (catch)، آن را مدیریت کرده و برنامه را در یک وضعیت پایدار نگه داریم.</p>
    </section>

    <section id="section-1">
        <h2>۱. سلسله‌مراتب استثناها در جاوا</h2>

        <p>در جاوا، همه خطاها اشیائی هستند که از کلاس <code>Throwable</code> ارث‌بری می‌کنند. این کلاس دو فرزند اصلی دارد: <code>Error</code> و <code>Exception</code>.</p>

        <div class="diagram-container">
            <svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg" dir="ltr">
                <defs>
                    <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <path d="M0,0 L0,6 L9,3 z" fill="#6b7280" />
                    </marker>
                </defs>

                <!-- Throwable -->
                <rect x="250" y="20" width="100" height="50" rx="5" class="throwable-box"/>
                <text x="300" y="50" text-anchor="middle" font-weight="bold">Throwable</text>

                <!-- Error -->
                <rect x="100" y="100" width="120" height="50" rx="5" class="error-box"/>
                <text x="160" y="130" text-anchor="middle" font-weight="bold" fill="#7f1d1d">Error</text>
                <text x="160" y="170" text-anchor="middle" font-size="11" fill="#7f1d1d">(Fatal - سیستم)</text>

                <!-- Exception -->
                <rect x="380" y="100" width="120" height="50" rx="5" class="exception-box"/>
                <text x="440" y="130" text-anchor="middle" font-weight="bold" fill="#581c87">Exception</text>
                <text x="440" y="170" text-anchor="middle" font-size="11" fill="#581c87">(قابل مدیریت)</text>

                <!-- RuntimeException -->
                <rect x="280" y="220" width="140" height="50" rx="5" class="unchecked-box"/>
                <text x="350" y="250" text-anchor="middle" font-weight="bold" fill="#9a3412">RuntimeException</text>

                <!-- IOException (Checked) -->
                <rect x="450" y="220" width="120" height="50" rx="5" class="exception-box"/>
                <text x="510" y="250" text-anchor="middle" font-weight="bold" fill="#581c87">IOException</text>

                <!-- Connectors -->
                <path d="M 300 70 L 300 85 L 160 85 L 160 100" class="connector" marker-end="url(#arrowHead)"/>
                <path d="M 300 70 L 300 85 L 440 85 L 440 100" class="connector" marker-end="url(#arrowHead)"/>

                <path d="M 440 150 L 440 200 L 350 200 L 350 220" class="connector" marker-end="url(#arrowHead)"/>
                <path d="M 440 150 L 440 200 L 510 200 L 510 220" class="connector" marker-end="url(#arrowHead)"/>

                <!-- Unchecked Examples -->
                <text x="350" y="290" text-anchor="middle" font-size="11">- NullPointerException</text>
                <text x="350" y="310" text-anchor="middle" font-size="11">- ArithmeticException</text>

                <!-- Checked Examples -->
                <text x="510" y="290" text-anchor="middle" font-size="11">- FileNotFoundException</text>
            </svg>
        </div>

        <ul>
            <li><strong>Error:</strong> خطاهای سیستمی و جدی که معمولاً برنامه نباید (و نمی‌تواند) آن‌ها را مدیریت کند. مانند <code>OutOfMemoryError</code>.</li>
            <li><strong>Exception:</strong> خطاهایی که برنامه <strong>می‌تواند و باید</strong> آن‌ها را مدیریت کند.</li>
        </ul>
    </section>

    <section id="section-2">
        <h2>۲. Checked در مقابل Unchecked Exceptions: یک تفاوت کلیدی</h2>

        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>معیار</th>
                    <th>Checked Exception (بررسی‌شده)</th>
                    <th>Unchecked Exception (بررسی‌نشده)</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td><strong>مفهوم</strong></td>
                    <td>خطاهای خارج از کنترل (فایل، شبکه).</td>
                    <td>خطاهای منطقی و باگ برنامه.</td>
                </tr>
                <tr>
                    <td><strong>بررسی کامپایلر</strong></td>
                    <td>✅ <strong>اجباری.</strong> باید <code>catch</code> یا <code>throws</code> شوند.</td>
                    <td>❌ <strong>اختیاری.</strong> کامپایلر اجبار نمی‌کند.</td>
                </tr>
                <tr>
                    <td><strong>کلاس والد</strong></td>
                    <td><code>Exception</code> (به جز Runtime).</td>
                    <td><code>RuntimeException</code>.</td>
                </tr>
                <tr>
                    <td><strong>مثال</strong></td>
                    <td><code>IOException</code>, <code>SQLException</code></td>
                    <td><code>NullPointerException</code>, <code>ArithmeticException</code></td>
                </tr>
                <tr>
                    <td><strong>فلسفه</strong></td>
                    <td>"برای این مشکل آماده باش."</td>
                    <td>"این یک باگ است، آن را رفع کن."</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <section id="section-3">
        <h2>۳. بلوک <code>try-catch-finally</code>: جعبه ابزار مدیریت خطا</h2>

        <ul>
            <li><strong>try:</strong> کدی که "ممکن است" استثنا ایجاد کند.</li>
            <li><strong>catch:</strong> مدیریت خطا در صورت وقوع.</li>
            <li><strong>finally:</strong> کدی که <strong>همیشه</strong> اجرا می‌شود (معمولاً برای بستن منابع).</li>
        </ul>

        <div class="code-block-container">
            <button class="copy-button" onclick="copyCode(this)">کپی</button>
            <pre><code class="language-java">public void readFile(String path) {
    FileReader fr = null;
    try {
        System.out.println("1. Trying to open file...");
        fr = new FileReader(path);
        // ... خواندن فایل ...
    } catch (FileNotFoundException e) {
        // مدیریت خطای پیدا نشدن فایل
        System.err.println("Error: File not found: " + path);
    } catch (IOException e) {
        // مدیریت سایر خطاهای ورودی/خروجی
        System.err.println("Error: IO Error.");
    } finally {
        System.out.println("3. Finally: Cleaning up resources...");
        try {
            if (fr != null) fr.close(); // بستن منبع
        } catch (IOException ex) {
            ex.printStackTrace();
        }
    }
}</code></pre>
        </div>

        <h3>نکته مدرن: <code>try-with-resources</code> (Java 7+)</h3>
        <p>برای بستن خودکار منابع، از این ساختار استفاده کنید:</p>
        <div class="code-block-container">
            <button class="copy-button" onclick="copyCode(this)">کپی</button>
            <pre><code class="language-java">public void readFileModern(String path) {
    // منبع در پرانتز try تعریف می‌شود و خودکار بسته می‌شود
    try (FileReader fr = new FileReader(path)) {
        // ... استفاده از منبع ...
    } catch (IOException e) {
        System.err.println("Error: " + e.getMessage());
    }
}</code></pre>
        </div>
    </section>

    <section id="section-4">
        <h2>۴. ساخت استثنای سفارشی (Custom Exception)</h2>

        <p>شما می‌توانید برای خطاهای خاص دامنه کسب‌وکار خود، استثنا بسازید.</p>

        <div class="code-block-container">
            <button class="copy-button" onclick="copyCode(this)">کپی</button>
            <pre><code class="language-java">// 1. تعریف استثنای سفارشی
public class InsufficientBalanceException extends Exception { // Checked
    private final double deficit;

    public InsufficientBalanceException(String message, double deficit) {
        super(message);
        this.deficit = deficit;
    }

    public double getDeficit() { return deficit; }
}

// 2. استفاده در کلاس BankAccount
public class BankAccount {
    private double balance;

    public void withdraw(double amount) throws InsufficientBalanceException {
        if (amount > balance) {
            // پرتاب کردن استثنای سفارشی
            throw new InsufficientBalanceException("Not enough money!", amount - balance);
        }
        this.balance -= amount;
    }
}</code></pre>
        </div>
    </section>

    <section id="section-5">
        <h2>۵. اشتباهات رایج</h2>

        <h3>الف) نادیده گرفتن استثنا (Empty Catch)</h3>
        <div class="code-block-container">
            <button class="copy-button" onclick="copyCode(this)">کپی</button>
            <pre><code class="language-java">// ❌ فاجعه‌بار!
try {
    int result = 10 / 0;
} catch (ArithmeticException e) {
    // خالی! خطا قورت داده می‌شود و برنامه با وضعیت خراب ادامه می‌یابد.
}</code></pre>
        </div>

        <h3>ب) گرفتن استثنای کلی (Catching Exception)</h3>
        <div class="code-block-container">
            <button class="copy-button" onclick="copyCode(this)">کپی</button>
            <pre><code class="language-java">// ❌ ضعیف
try {
    // ...
} catch (Exception e) {
    // نمی‌دانیم چه خطایی رخ داده (فایل؟ ریاضی؟ نال؟)
}</code></pre>
        </div>

        <h3>ج) استفاده از استثنا برای کنترل جریان (Flow Control)</h3>
        <div class="code-block-container">
            <button class="copy-button" onclick="copyCode(this)">کپی</button>
            <pre><code class="language-java">// ❌ بسیار کند و بد
try {
    int i = 0;
    while (true) {
        System.out.println(array[i++]);
    }
} catch (ArrayIndexOutOfBoundsException e) {
    // پایان حلقه با خطا!
}</code></pre>
        </div>
    </section>

    <section id="exercises">
        <h2>۶. تمرین‌های عملی</h2>

        <div class="exercise-box">
            <h3>تمرین ۱: تقسیم امن</h3>
            <p>متدی بنویسید که دو عدد صحیح را گرفته و تقسیم کند. خطای <code>ArithmeticException</code> (تقسیم بر صفر) را با <code>try-catch</code> مدیریت کنید و پیام مناسب دهید.</p>
        </div>

        <div class="exercise-box">
            <h3>تمرین ۲: تکمیل <code>BankAccount</code></h3>
            <p>با استفاده از کلاس <code>BankAccount</code> و استثنای <code>InsufficientBalanceException</code> که در بالا تعریف شد:</p>
            <ol>
                <li>یک حساب با موجودی ۱۰۰۰ بسازید.</li>
                <li>تلاش کنید ۱۵۰۰ برداشت کنید.</li>
                <li>در <code>try-catch</code>، استثنا را گرفته و میزان کمبود موجودی را چاپ کنید.</li>
            </ol>
        </div>

        <div class="exercise-box">
            <h3>تمرین ۳: مدیریت چندگانه</h3>
            <p>متدی بنویسید که نام فایل را گرفته، محتوای آن (که عدد است) را بخواند و به <code>int</code> تبدیل کند.</p>
            <ul>
                <li><code>FileNotFoundException</code> را مدیریت کنید.</li>
                <li><code>NumberFormatException</code> را مدیریت کنید.</li>
            </ul>
        </div>

        <div class="exercise-box">
            <h3>تمرین ۴: پاک‌سازی با <code>finally</code></h3>
            <p>یک <code>Scanner</code> بسازید و در بلوک <code>try</code> یک عدد بخوانید. در <code>finally</code> مطمئن شوید که <code>scanner.close()</code> صدا زده می‌شود.</p>
        </div>

        <div class="exercise-box">
            <h3>تمرین ۵: تحلیل و اصلاح کد</h3>
            <p>کد زیر چه مشکلی دارد؟ اصلاح کنید.</p>
            <div class="code-block-container">
                <button class="copy-button" onclick="copyCode(this)">کپی</button>
                <pre><code class="language-java">public static int getLength(String s) {
    try {
        return s.length();
    } catch (Exception e) {
        return 0;
    }
}
// getLength(null) -> 0 (آیا منطقی است باگ NullPointer را مخفی کنیم؟)</code></pre>
            </div>
        </div>
    </section>

    <section id="summary">
        <h2>خلاصه بخش نوزدهم</h2>
        <div class="summary-box">
            <ul>
                <li>✅ <strong>Exception:</strong> رویدادی که جریان عادی برنامه را مختل می‌کند.</li>
                <li>✅ <strong>try-catch-finally:</strong> ساختار اصلی مدیریت خطا.</li>
                <li>✅ <strong>Checked:</strong> اجباری توسط کامپایلر (مثل IOException).</li>
                <li>✅ <strong>Unchecked:</strong> اختیاری، معمولاً باگ برنامه (مثل NullPointer).</li>
                <li>✅ <strong>try-with-resources:</strong> بهترین راه مدیریت منابع (AutoCloseable).</li>
            </ul>
        </div>

        <div class="next-section">
            <p><strong>در بخش بعدی:</strong> انواع شمارشی (Enums) — تعریف مجموعه‌ای از ثابت‌های امن</p>
            <div class="part-navigation">
                <a href="part18.html" class="btn-prev">→ بخش قبلی</a>
                <a href="part20.html" class="btn-next">بخش بعدی: Enums ←</a>
            </div>
        </div>
    </section>
</main>

<script src="../assets/js/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>

</body>
</html>